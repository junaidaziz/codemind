name: Auto Fix Build & Deployment Failures

on:
  workflow_dispatch:
  push:
    branches: [ main, develop ]
  repository_dispatch:
    types: [vercel-build-failed]
  workflow_run:
    workflows: ["CI/CD Pipeline"]
    types:
      - completed
    branches: [ main, develop ]

permissions:
  contents: write  # Create branches and PRs
  issues: write    # Create GitHub issues with analysis results
  pull-requests: write  # Create auto-fix PRs

jobs:
  analyze-build-failure:
    runs-on: ubuntu-latest
    # Run if: CI/CD workflow failed, or repository dispatch event, or manual trigger
    if: |
      github.event_name == 'workflow_dispatch' ||
      github.event_name == 'repository_dispatch' ||
      (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'failure') ||
      (github.event_name == 'push')
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: '9'

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Determine failure type and source
        id: failure-detection
        run: |
          echo "ğŸ” Determining failure type..."
          
          # Determine what triggered this workflow
          if [ "${{ github.event_name }}" == "workflow_run" ]; then
            echo "ğŸ“‹ Build failure detected from CI/CD pipeline"
            echo "failure_type=build" >> $GITHUB_OUTPUT
            echo "failure_source=github" >> $GITHUB_OUTPUT
            
            echo "FAILURE_TYPE=build" >> $GITHUB_ENV
            echo "WORKFLOW_RUN_ID=${{ github.event.workflow_run.id }}" >> $GITHUB_ENV
            echo "FAILURE_SOURCE=github" >> $GITHUB_ENV
            
            # Create logs directory
            mkdir -p logs
            
            # Fetch failed workflow logs using GitHub API
            echo "ğŸ“„ Fetching GitHub workflow logs..."
            curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              -H "Accept: application/vnd.github.v3+json" \
              "https://api.github.com/repos/${{ github.repository }}/actions/runs/${{ github.event.workflow_run.id }}/jobs" \
              > logs/github_jobs.json
            
            # Extract failed job logs
            FAILED_JOB_ID=$(jq -r '.jobs[] | select(.conclusion == "failure") | .id' logs/github_jobs.json | head -1)
            
            if [ -n "$FAILED_JOB_ID" ] && [ "$FAILED_JOB_ID" != "null" ]; then
              echo "ğŸ“¥ Downloading logs for failed job: $FAILED_JOB_ID"
              curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
                -H "Accept: application/vnd.github.v3+json" \
                "https://api.github.com/repos/${{ github.repository }}/actions/jobs/$FAILED_JOB_ID/logs" \
                > logs/github_build_logs.txt
              
              echo "JOB_ID=$FAILED_JOB_ID" >> $GITHUB_ENV
              echo "has_logs=true" >> $GITHUB_OUTPUT
            else
              echo "âš ï¸ Could not find failed job ID"
              echo "has_logs=false" >> $GITHUB_OUTPUT
            fi
            
          elif [ "${{ github.event_name }}" == "repository_dispatch" ]; then
            echo "ğŸ“‹ Vercel deployment failure detected from webhook"
            echo "failure_type=deployment" >> $GITHUB_OUTPUT
            echo "failure_source=vercel" >> $GITHUB_OUTPUT
            
            echo "FAILURE_TYPE=deployment" >> $GITHUB_ENV
            echo "FAILURE_SOURCE=vercel" >> $GITHUB_ENV
            
          else
            echo "ğŸ“‹ Manual trigger or push event - checking for recent failures"
            echo "failure_type=check" >> $GITHUB_OUTPUT
            echo "failure_source=manual" >> $GITHUB_OUTPUT
            
            echo "FAILURE_TYPE=check" >> $GITHUB_ENV
            echo "FAILURE_SOURCE=manual" >> $GITHUB_ENV
          fi
          
          echo "Failure type: $(echo $FAILURE_TYPE)"
          echo "Failure source: $(echo $FAILURE_SOURCE)"

      - name: Fetch Vercel deployment logs
        if: steps.failure-detection.outputs.failure_source == 'vercel' || steps.failure-detection.outputs.failure_type == 'check'
        run: |
          echo "ğŸ” Fetching latest failed Vercel deployment..."
          
          # Get the latest failed deployment
          DEPLOYMENT_RESPONSE=$(curl -s -H "Authorization: Bearer ${{ secrets.VERCEL_TOKEN }}" \
            "https://api.vercel.com/v6/deployments?projectId=${{ secrets.VERCEL_PROJECT_ID }}&state=ERROR&limit=1")
          
          echo "Deployment response: $DEPLOYMENT_RESPONSE"
          
          # Extract deployment ID
          DEPLOYMENT_ID=$(echo "$DEPLOYMENT_RESPONSE" | jq -r '.deployments[0].uid // empty')
          
          if [ -z "$DEPLOYMENT_ID" ] || [ "$DEPLOYMENT_ID" = "null" ]; then
            echo "âœ… No failed deployments found!"
            echo "NO_FAILURES=true" >> $GITHUB_ENV
            exit 0
          fi
          
          echo "âŒ Found failed deployment: $DEPLOYMENT_ID"
          echo "DEPLOYMENT_ID=$DEPLOYMENT_ID" >> $GITHUB_ENV
          
          # Fetch detailed build logs
          echo "ğŸ“„ Fetching build logs..."
          curl -s -H "Authorization: Bearer ${{ secrets.VERCEL_TOKEN }}" \
            "https://api.vercel.com/v2/deployments/$DEPLOYMENT_ID/events?teamId=${{ secrets.VERCEL_TEAM_ID }}" \
            > vercel_logs.json
          
          # Check if logs were fetched successfully
          if [ ! -s vercel_logs.json ]; then
            echo "âŒ Failed to fetch build logs"
            exit 1
          fi
          
          echo "ğŸ“„ Build logs fetched successfully"

      - name: Analyze logs with our TypeScript script
        if: env.NO_FAILURES != 'true'
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
          VERCEL_TEAM_ID: ${{ secrets.VERCEL_TEAM_ID }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPO: ${{ github.repository }}
        run: |
          echo "ğŸ¤– Running AI analysis with our enhanced script..."
          pnpm run analyze-vercel

      - name: Check for AI analysis results
        if: env.NO_FAILURES != 'true'
        run: |
          if [ -f "logs/vercel-fail.json" ]; then
            echo "ğŸ“‹ Analysis completed - checking results..."
            
            # Extract analysis summary for commit message
            SUMMARY=$(jq -r '.analysis.summary // "Build failure analysis completed"' logs/vercel-fail.json)
            CAUSE=$(jq -r '.analysis.cause // "Unknown cause"' logs/vercel-fail.json)
            FIX=$(jq -r '.analysis.fix // "See analysis for details"' logs/vercel-fail.json)
            
            echo "FAILURE_SUMMARY=$SUMMARY" >> $GITHUB_ENV
            echo "FAILURE_CAUSE=$CAUSE" >> $GITHUB_ENV
            echo "FAILURE_FIX=$FIX" >> $GITHUB_ENV
            
            # Create a comprehensive analysis markdown file
            cat > ai_analysis.md << EOF
          # ğŸ” Vercel Build Failure Analysis
          
          **Generated on:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')
          **Deployment ID:** $DEPLOYMENT_ID
          **Repository:** ${{ github.repository }}
          **Branch:** ${{ github.ref_name }}
          **Commit:** ${{ github.sha }}
          
          ## âŒ Build Failure Summary
          $SUMMARY
          
          ## ğŸ” Root Cause Analysis
          $CAUSE
          
          ## ğŸ› ï¸ Suggested Fix
          $FIX
          
          ## ğŸ“Š Full Analysis
          \`\`\`json
          $(cat logs/vercel-fail.json | jq '.')
          \`\`\`
          
          ---
          *This analysis was generated automatically by our AI-powered build failure analyzer.*
          EOF
            
            echo "âœ… Analysis report created"
          else
            echo "âŒ No analysis file found"
            exit 1
          fi

      - name: Create branch and commit analysis results
        if: env.NO_FAILURES != 'true'
        run: |
          # Configure git with your information
          git config user.name "Junaid Aziz"
          git config user.email "junaidaziz@users.noreply.github.com"
          
          # Create unique branch name
          BRANCH_NAME="auto-fix/deployment-failure-$(date +%Y%m%d-%H%M%S)"
          echo "BRANCH_NAME=$BRANCH_NAME" >> $GITHUB_ENV
          
          # Create and checkout new branch
          git checkout -b $BRANCH_NAME
          
          # Add analysis files
          git add ai_analysis.md logs/vercel-fail.json
          
          # Check if there are changes to commit
          if git diff --staged --quiet; then
            echo "No changes to commit"
            echo "SKIP_PR=true" >> $GITHUB_ENV
            exit 0
          fi
          
          # Create commit with detailed message
          git commit -m "ğŸ¤– Auto-Fix: Analysis for deployment failure

          ğŸ” Root Cause: $FAILURE_CAUSE
          ğŸ› ï¸ Suggested Fix: $FAILURE_FIX
          ğŸ“Š Confidence: AI-generated analysis
          
          Deployment ID: $DEPLOYMENT_ID
          Analysis generated by CodeMind Auto-Fix System
          
          Files added:
          - ai_analysis.md: Human-readable analysis report  
          - logs/vercel-fail.json: Complete diagnostic data
          
          Please review the analysis and apply the suggested fixes."
          
          # Push the branch
          git push origin $BRANCH_NAME
          echo "âœ… Branch $BRANCH_NAME created and pushed"

      - name: Create Pull Request
        if: env.NO_FAILURES != 'true' && env.SKIP_PR != 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const branchName = process.env.BRANCH_NAME;
            
            const title = `ğŸ¤– Auto-Fix: ${process.env.FAILURE_SUMMARY || 'Deployment Failure Analysis'}`;
            const body = `## ğŸ¤– Automated Build Failure Analysis
            
            This PR contains automated analysis for a deployment failure detected in the system.
            
            ### ğŸ“Š Analysis Summary
            - **Deployment ID:** \`${process.env.DEPLOYMENT_ID}\`
            - **Root Cause:** ${process.env.FAILURE_CAUSE}
            - **Confidence:** AI-powered analysis using GPT-4o-mini
            
            ### ğŸ› ï¸ Suggested Resolution
            ${process.env.FAILURE_FIX}
            
            ### ğŸ“ Files Added
            - \`ai_analysis.md\` - Detailed human-readable analysis
            - \`logs/vercel-fail.json\` - Complete diagnostic data and logs
            
            ### ğŸ”„ Next Steps
            1. Review the analysis in \`ai_analysis.md\`
            2. Apply the suggested fixes to resolve the deployment issue
            3. Test the changes locally before merging
            4. Merge this PR to keep the analysis for future reference
            
            ---
            
            **ğŸ¤– Generated by:** CodeMind Auto-Fix System  
            **ğŸ“… Created:** ${new Date().toISOString()}  
            **ğŸ¯ Type:** Automated Analysis & Documentation
            
            > This PR documents the failure analysis and does not contain direct code fixes.
            > Please implement the suggested changes in a separate PR or commit.`;
            
            const pr = await github.rest.pulls.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              head: branchName,
              base: 'main',
              draft: false
            });
            
            // Add labels to the PR
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr.data.number,
              labels: ['auto-fix', 'deployment-failure', 'analysis', 'documentation']
            });
            
            console.log(`âœ… Created Pull Request #${pr.data.number}`);
            console.log(`ğŸ”— PR URL: ${pr.data.html_url}`);

      - name: Create GitHub Issue for repeated failures
        if: env.NO_FAILURES != 'true'
        uses: actions/github-script@v7
        with:
          script: |
            // Check if this is a repeated failure that should create an issue
            const fs = require('fs');
            
            if (!fs.existsSync('logs/vercel-fail.json')) {
              console.log('No analysis file found, skipping issue creation');
              return;
            }
            
            const analysis = JSON.parse(fs.readFileSync('logs/vercel-fail.json', 'utf8'));
            
            // Only create issue if failure count >= 3 for the same commit
            if (analysis.failureTracking && analysis.failureTracking.failureCount >= 3) {
              const title = `ğŸš¨ Repeated Build Failure: ${analysis.analysis.summary}`;
              const body = `
              ## ğŸš¨ Repeated Build Failure Alert
              
              This commit has failed **${analysis.failureTracking.failureCount} times** in a row.
              
              **Commit SHA:** \`${analysis.failureTracking.commitSha}\`
              **First Failure:** ${analysis.failureTracking.firstFailure}
              **Latest Failure:** ${analysis.failureTracking.lastFailure}
              
              ## âŒ Build Failure Summary
              ${analysis.analysis.summary}
              
              ## ğŸ” Root Cause Analysis  
              ${analysis.analysis.cause}
              
              ## ğŸ› ï¸ Suggested Fix
              ${analysis.analysis.fix}
              
              ## ğŸ“‹ Action Required
              - [ ] Review the suggested fix above
              - [ ] Test the fix locally before deploying
              - [ ] Update relevant documentation if needed
              - [ ] Close this issue once resolved
              
              ---
              
              **Deployment ID:** \`${analysis.deployment.uid}\`
              **Auto-generated by:** Vercel Build Failure Analyzer
              `;
              
              // Create the issue
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['bug', 'deployment', 'automated', 'high-priority']
              });
              
              console.log('âœ… GitHub issue created for repeated failure');
            } else {
              console.log('ğŸ“Š Failure count not high enough for issue creation');
            }

      - name: Summary
        if: always()
        run: |
          echo "ğŸ‰ Vercel Build Failure Analysis Workflow Complete!"
          echo ""
          if [ "$NO_FAILURES" = "true" ]; then
            echo "âœ… Status: No failed deployments found"
          else
            echo "ğŸ“Š Status: Analysis completed for deployment $DEPLOYMENT_ID"
            echo "ğŸ“ Files created:"
            echo "  - ai_analysis.md (human-readable report)"
            echo "  - logs/vercel-fail.json (complete analysis data)"
          fi
          echo ""
          echo "ğŸ”— View full analysis: https://github.com/${{ github.repository }}/blob/${{ github.ref_name }}/ai_analysis.md"